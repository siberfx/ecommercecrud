<?php

namespace SmartyStudio\EcommerceCrud\app\Http\Controllers\Admin;

use LaravelDaily\Invoices\Classes\Party;
use LaravelDaily\Invoices\Invoice;
use LaravelDaily\Invoices\Classes\Buyer;
use LaravelDaily\Invoices\Classes\InvoiceItem;
use App\Http\Controllers\Controller;

class InvoiceController extends Controller
{
	public function generate()
	{
		$client = new Party([
			'name'            => 'Martin Nestorov',
			'phone'           => '+359 888 777 666',
			'custom_fields'   => [
				'note'        => 'Smarty Studio',
				'business id' => '365#GG',
			],
		]);

		$customer = new Party([
			'name'          => 'Just a client',
			'address'       => 'Address of the client',
			'code'          => '#22663214',
			'custom_fields' => [
				'order number' => '> 654321 <',
			],
		]);

		$items = [
			(new InvoiceItem())->title('Service 1')->pricePerUnit(47.79)->quantity(2)->discount(10),
			(new InvoiceItem())->title('Service 4')->pricePerUnit(87.51)->quantity(7)->discount(4)->units('kg'),
			(new InvoiceItem())->title('Service 6')->pricePerUnit(76.32)->quantity(9),
			(new InvoiceItem())->title('Service 14')->pricePerUnit(160)->units('hours'),
			(new InvoiceItem())->title('Service 15')->pricePerUnit(62.21)->discountByPercent(5),
			(new InvoiceItem())->title('Service 18')->pricePerUnit(29.81)->discountByPercent(8),
			(new InvoiceItem())->title('Service 20')->pricePerUnit(55.80),
		];

		$notes = [
			'your multiline',
			'additional notes',
			'in regards of delivery or something else',
		];
		$notes = implode("<br>", $notes);

		$invoice = Invoice::make('receipt')
			->series('BIG')
			->sequence(667)
			->serialNumberFormat('{SEQUENCE}/{SERIES}')
			->seller($client)
			->buyer($customer)
			->date(now()->subWeeks(3))
			->dateFormat('m/d/Y')
			->payUntilDays(14)
			->currencySymbol('$')
			->currencyCode('USD')
			->currencyFormat('{SYMBOL}{VALUE}')
			->currencyThousandsSeparator('.')
			->currencyDecimalPoint(',')
			->filename($client->name . ' ' . $customer->name)
			->addItems($items)
			->notes($notes)
			->logo(public_path('uploads/logo.png'))
			// You can additionally save generated invoice to configured disk
			->save('public');

		$link = $invoice->url();
		// Then send email to party with link

		// And return invoice itself to browser or have a different view
		return $invoice->stream();
	}

	public function toBuyer()
	{
		$customer = new Buyer([
			'name'          => 'John Doe',
			'custom_fields' => [
				'email' => 'test@example.com',
			],
		]);

		$item = (new InvoiceItem())->title('Service 1')->pricePerUnit(2);

		$invoice = Invoice::make()
			->buyer($customer)
			->discountByPercent(10)
			->taxRate(15)
			->shipping(1.99)
			->addItem($item);

		return $invoice->stream();
	}
}